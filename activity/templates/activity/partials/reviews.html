{% load crispy_forms_tags %}

<div class="col-12">
  <h3>User Reviews</h3>

  {% if user.is_authenticated %}
    <div id="review" class="card-body">

      <!-- EDIT MODE -->
      {% if form and form.instance.pk %}
        <h4 class="mb-2">Edit your review</h4>
        <form data-testid="edit-review-form" id="reviewForm" method="post" action="{% url 'add_review' book.id %}">
          {% csrf_token %}
          {{ form.non_field_errors }}
          {{ form.content.errors }}
          {{ form.content }}
          <div class="mt-2 d-flex gap-2 flex-row-reverse">
            <a href="{% url 'book_detail' book.id %}#review" class="nc-btn nc-btn--muted">Cancel</a>
            <button id="submitButton" type="submit" class="nc-btn nc-btn--primary">Save</button>
          </div>
        </form>

      <!-- CREATE MODE -->
      {% elif not my_review %}
        <h4 class="mb-2">Leave a review</h4>
        <p class="mb-2">Posting as: <strong>{{ user.username }}</strong></p>
        <form data-testid="create-review-form" id="reviewForm" method="post" action="{% url 'add_review' book.id %}" style="margin-top:1.0em;">
          {% csrf_token %}
          {{ form.non_field_errors }}
          {{ form.content.errors }}
          {{ form.content }}
          <div class="mt-2 d-flex gap-2 flex-row-reverse">
            <button id="submitButton" type="submit" class="nc-btn nc-btn--primary">Submit</button>
          </div>
        </form>
      {% endif %}

      <!-- REVIEWS LIST  -->
      <ul class="list-unstyled mt-3">

        <!-- Render the authenticated user's review at the top -->
        {% if my_review and not edit_mode %}
          <li class="mb-3 border rounded p-3 bg-light">
            <div class="d-flex justify-content-between align-items-start">
              <div>
                <strong>You</strong>
                <small class="text-muted d-block">
                  Last updated: {{ my_review.updated_at|date:"M d, Y" }}
                </small>
              </div>
              <div class="ms-3">
                <a class="nc-btn nc-btn--icon nc-btn--sm nc-btn--ghost"
                   data-testid="edit-my-review-button"
                   aria-label="Edit review"
                   title="Edit"
                   href="{% url 'book_detail' book.id %}?edit=1#review">
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640"><!--!Font Awesome Free v7.0.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free Copyright 2025 Fonticons, Inc.--><path fill="#00796b" d="M416.9 85.2L372 130.1L509.9 268L554.8 223.1C568.4 209.6 576 191.2 576 172C576 152.8 568.4 134.4 554.8 120.9L519.1 85.2C505.6 71.6 487.2 64 468 64C448.8 64 430.4 71.6 416.9 85.2zM338.1 164L122.9 379.1C112.2 389.8 104.4 403.2 100.3 417.8L64.9 545.6C62.6 553.9 64.9 562.9 71.1 569C77.3 575.1 86.2 577.5 94.5 575.2L222.3 539.7C236.9 535.6 250.2 527.9 261 517.1L476 301.9L338.1 164z"/></svg>
                </a>
               <form id="delete-review-{{ my_review.id }}"
                     method="post"
                     action="{% url 'delete_review' book.id my_review.id %}"
                     class="d-none">
               {% csrf_token %}
              </form>
              
              <button type="button"
                      title="Delete"
                      aria-label="Delete review"
                      data-testid="delete-my-review-button"
                      class="nc-btn nc-btn--icon nc-btn--sm nc-btn--ghost"
                      data-bs-toggle="modal"
                      data-bs-target="#confirmDeleteModal"
                      data-form="delete-review-{{ my_review.id }}"
                      data-message="Delete your review?">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640"><!--!Font Awesome Free v7.0.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free Copyright 2025 Fonticons, Inc.--><path fill="#e13545" d="M232.7 69.9L224 96L128 96C110.3 96 96 110.3 96 128C96 145.7 110.3 160 128 160L512 160C529.7 160 544 145.7 544 128C544 110.3 529.7 96 512 96L416 96L407.3 69.9C402.9 56.8 390.7 48 376.9 48L263.1 48C249.3 48 237.1 56.8 232.7 69.9zM512 208L128 208L149.1 531.1C150.7 556.4 171.7 576 197 576L443 576C468.3 576 489.3 556.4 490.9 531.1L512 208z"/></svg>
              </button>
              </div>
            </div>
            <p class="mb-0 mt-2">{{ my_review.content }}</p>
          </li>
        {% endif %}

        {% for review in reviews %}
          <li class="mb-3 border rounded p-3 {% if user.is_authenticated and review.user_id == user.id %}bg-light{% endif %}">
            <div class="d-flex justify-content-between align-items-start">
              <div>
                <strong>
                  {% if user.is_authenticated and review.user_id == user.id %}
                    You
                  {% else %}
                    {{ review.user.username }}
                  {% endif %}
                </strong>
                <small class="text-muted d-block">
                  {{ review.created_at|date:"M d, Y" }}
                </small>
              </div>

              {% if user.is_authenticated and review.user_id == user.id %}
                <div class="ms-3">
                  <a class="nc-btn nc-btn--icon nc-btn--sm nc-btn--ghost"
                    data-testid="edit-review-button"
                    title="Edit"
                    aria-lable="Edit review"
                    href="{% url 'book_detail' book.id %}?edit=1#review">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640"><!--!Font Awesome Free v7.0.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free Copyright 2025 Fonticons, Inc.--><path fill="#00796b" d="M416.9 85.2L372 130.1L509.9 268L554.8 223.1C568.4 209.6 576 191.2 576 172C576 152.8 568.4 134.4 554.8 120.9L519.1 85.2C505.6 71.6 487.2 64 468 64C448.8 64 430.4 71.6 416.9 85.2zM338.1 164L122.9 379.1C112.2 389.8 104.4 403.2 100.3 417.8L64.9 545.6C62.6 553.9 64.9 562.9 71.1 569C77.3 575.1 86.2 577.5 94.5 575.2L222.3 539.7C236.9 535.6 250.2 527.9 261 517.1L476 301.9L338.1 164z"/></svg>
                  </a>
                  <form id="delete-review-{{ review.id }}"
                        method="post"
                        action="{% url 'delete_review' book.id review.id %}"
                        class="d-none">
                    {% csrf_token %}
                  </form>
                  <button type="button"
                          title="Delete"
                          aria-label="Delete review"
                          data-testid="delete-review-button"
                          class="nc-btn nc-btn--icon nc-btn--sm nc-btn--ghost"
                          data-bs-toggle="modal"
                          data-bs-target="#confirmDeleteModal"
                          data-form="delete-review-{{ review.id }}"
                          data-message="Delete your review?">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640"><!--!Font Awesome Free v7.0.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free Copyright 2025 Fonticons, Inc.--><path fill="#e13545" d="M232.7 69.9L224 96L128 96C110.3 96 96 110.3 96 128C96 145.7 110.3 160 128 160L512 160C529.7 160 544 145.7 544 128C544 110.3 529.7 96 512 96L416 96L407.3 69.9C402.9 56.8 390.7 48 376.9 48L263.1 48C249.3 48 237.1 56.8 232.7 69.9zM512 208L128 208L149.1 531.1C150.7 556.4 171.7 576 197 576L443 576C468.3 576 489.3 556.4 490.9 531.1L512 208z"/></svg>
                </div>
              {% endif %}
            </div>

            <p class="mb-0 mt-2">{{ review.content }}</p>
          </li>
        {% empty %}
          <!-- Only show "No reviews yet." if there is truly no review at all -->
          {% if not my_review %}
            <li>No reviews yet.</li>
          {% endif %}
        {% endfor %}
      </ul>
    </div>
  {% else %}
    <p class="text-muted text-center mt-4" data-testid="review-login-prompt">
      <a href="{{ login_url }}?next={{ request.get_full_path|urlencode }}">Log in</a>
      to write and read reviews
    </p>
  {% endif %}
</div>