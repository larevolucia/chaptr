{% extends "base.html" %}
{% load static i18n allauth account %}
{% block title %}{% trans "Email Addresses" %}{% endblock %}   

{% block content %}
<div class="auth-container">
    {% element h1 %}
        {% trans "Email Addresses" %}
    {% endelement %}
    {% if emailaddresses %}
        {% element p %}
            {% trans 'The following email addresses are associated with your account:' %}
        {% endelement %}
        {% url 'account_email' as email_url %}
        {% element form form=form action=email_url method="post" tags="email,list" %}
            {% slot body %}
                {% csrf_token %}
                {# group radios semantically and visually #}
                <fieldset class="email-list">
                    <legend class="visually-hidden">{% trans "Your email addresses" %}</legend>
                        {% for radio in emailaddress_radios %}
                            {% with emailaddress=radio.emailaddress %}
                                {% element field type="radio" checked=radio.checked name="email" value=emailaddress.email id=radio.id %}
                                    {% slot label %}
                                        {{ emailaddress.email }}
                                        {% if emailaddress.verified %}
                                            {% element badge tags="success,email,verified" %}
                                                {% translate "Verified" %}
                                            {% endelement %}
                                        {% else %}
                                            {% element badge tags="warning,email,unverified" %}
                                                {% translate "Unverified" %}
                                            {% endelement %}
                                        {% endif %}
                                        {% if emailaddress.primary %}
                                            {% element badge tags="email,primary" %}
                                                {% translate "Primary" %}
                                            {% endelement %}
                                        {% endif %}
                                    {% endslot %}
                                {% endelement %}
                            {% endwith %}
                        {% endfor %}
                </fieldset>
            {% endslot %}
            {% slot actions %}
                <div class="auth-actions email-actions">
                    <button class="btn btn-accent" type="submit" name="action_primary">
                        {% trans 'Make Primary' %}
                    </button>
                    <button class="btn btn-secondary" type="submit" name="action_send">
                        {% trans 'Re-send Verification' %}
                    </button>
                    <button class="btn btn-danger" type="submit" name="action_remove" formnovalidate>
                        {% trans 'Remove' %}
                    </button>
                </div>
            {% endslot %}
        {% endelement %}
    {% else %}
        {% include "account/snippets/warn_no_email.html" %}
    {% endif %}
    {% if can_add_email %}
        {% element h2 %}
            {% trans "Add Email Address" %}
        {% endelement %}
        {% url 'account_email' as action_url %}
        {% element form form=form method="post" action=action_url tags="email,add" %}
            {% slot body %}
                {% csrf_token %}
                {% element fields form=form %}
                {% endelement %}
            {% endslot %}
            {% slot actions %}
                {% element button name="action_add" type="submit" %}
                    {% trans "Add Email" %}
                {% endelement %}
            {% endslot %}
        {% endelement %}
    {% endif %}
</div>
{% endblock content %}
{% block extra_body %}
    <script src="{% static 'account/js/account.js' %}"></script>
    <script src="{% static 'account/js/onload.js' %}"></script>
    <script data-allauth-onload="allauth.account.forms.manageEmailForm" type="application/json">{
    "i18n": {"confirmDelete": "{% trans 'Do you really want to remove the selected email address?' %}"}
}
    </script>
{% endblock extra_body %}

{% block extra_body %}
  {{ block.super }}
  <script>
    (function () {
      const radios = document.querySelectorAll('input[type="radio"][name="email"]');
      const btnPrimary = document.querySelector('button[name="action_primary"]');
      const btnResend  = document.querySelector('button[name="action_send"]');

      // map email -> {primary, verified} using label text badges
      function getState(radio) {
        const label = document.querySelector(`label[for="${radio.id}"]`);
        const text = label ? label.textContent.toLowerCase() : "";
        return {
          primary:  text.includes("primary"),
          verified: text.includes("verified"),
        };
      }

      function updateButtons() {
        const current = document.querySelector('input[name="email"]:checked');
        if (!current) return;
        const { primary, verified } = getState(current);

        // disable "Make Primary" if already primary
        if (btnPrimary) {
          btnPrimary.disabled = primary;
          btnPrimary.setAttribute("aria-disabled", String(primary));
        }

        // hide "Re-send Verification" for verified addresses
        if (btnResend) {
          btnResend.style.display = verified ? "none" : "";
        }
      }

      radios.forEach(r => r.addEventListener('change', updateButtons));
      updateButtons();
    })();
  </script>
{% endblock %}

